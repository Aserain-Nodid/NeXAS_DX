# GUI 改进方案

以下方案基于当前 `MainView.fxml` 与主控制器模块（`MainViewController` 及其子控制器）的代码逻辑梳理后制定，仅聚焦图形界面层面的体验优化。

## 现状梳理
- 模式切换：顶部两个单选钮决定左侧树的根节点文字（`pack/unpack` 或 `parse/generate`），树仅承载操作类型，不承载待处理的资源。
- 文件选择：右侧表单要求用户为解析/生成逐一指定单个文件，`FilePickerController` 依据后缀自动切换树节点，并在偏好设置中记录最近一次路径。
- 操作执行：`ActionButtonController` 根据树节点字符串触发具体服务类，运行结果写入底部日志。
- 布局不足：树与表单区紧耦合，无法直观反映当前目录的文件结构；按钮 `...` 文本存在乱码；`DragAndDropController` 未挂载无法生效。

## 需求解读
1. **批处理**：不再频繁切换单个文件，直接对选定目录下的所有文件执行解析/生成。
2. **Grid 展示分支**：在选择目录后，以网格形式展示各分支（可理解为“每一类文件/子树”的概览卡片），便于快速定位与批量操作。
3. **界面布局优化**：调整现有控件的摆放与命名，使信息层次更清晰、操作路径更短。

为便于推进，默认假设：
- “分支（树）”指按功能或文件类别划分的子集，例如 `.waz / .mek / .grp` 等，每个分支需要在右侧网格中生成一个卡片或面板，展示该类文件并提供操作入口。
- 解析/生成仍采用现有后台服务，只是一次遍历目录中的多个目标文件。

## 改进设计
### 1. 批量载入与操作流程
- 将输入选择统一为目录层级（文件夹选择器与拖入目录），选中后自动扫描子目录及文件。
- 左侧树改为展示扫描结果的层级结构：根节点为目录，第一层为文件类型分类（或原有 `parse/generate` 功能），叶子节点列出具体文件。
- `ActionButtonController` 扩展为对多文件迭代执行：点击某个卡片或批量执行按钮时，按类型批量调用 `BsdxBinService`/`PacService`，记录成功与失败数量。

### 2. Grid 视图呈现
- 在右侧区域新建 `ScrollPane` + `TilePane` / `FlowPane`，用于渲染“卡片”。每个卡片关联一个树分支，显示：
  - 分支标题（如 `.waz` 文件）
  - 统计信息（文件数、目标输出目录）
  - 操作按钮（`全部解析`、`全部生成` 等）
- 树节点选择与右侧网格联动：点击树节点时，定位或高亮对应卡片；卡片上的按钮反过来选中树节点并触发批处理。
- 网格内支持二级面板折叠展示单个文件列表，必要时可嵌入 `ListView` 或 `TableView`。

### 3. 布局与易用性优化
- 顶部：将模式切换改为 `ToggleButton` 组或 `SegmentedButton`，与主流程保持一致；修复按钮文本乱码（改为中文或标准英文 `...`）。
- 表单区：重排为“目录选择 + 输出基准目录 + 操作选项”，并将锁定输出的逻辑迁移为全局开关；在表单下方加入“批量执行”汇总按钮。
- 日志区：移动到窗口底部并占满宽度，增加等级标识颜色（信息/警告/错误）。
- 菜单：扩展 `Settings` 为真正的设置弹窗（编码、游戏模式选择、默认输出策略），保存到偏好设置并与控制器联动。
- 启用拖放：在 `MainViewController.initialize()` 中注入 `DragAndDropController`，允许拖拽目录快速载入。

## 主要实现步骤
1. **更新 FXML**
   - 在 `BorderPane` 中将右侧拆分为 `SplitPane`：左侧树 + 右侧 `ScrollPane` 内嵌 `TilePane`。
   - 调整顶部和表单区控件，替换有问题的文本，添加批处理控制按钮与状态标签。
2. **重构控制器**
   - 新增 `DirectoryScanController`（或在 `FilePickerController` 扩展）负责遍历目录，构建文件分类数据模型。
   - 扩展 `ModeTreeController` 生成真实树结构，并提供选择监听回调供网格刷新。
   - 新建 `BranchGridController` 管理网格视图，与树节点、批量执行动作相互通讯。
   - 调整 `ActionButtonController` 支持单个文件、批量文件两种入口，并在日志中输出批次统计。
3. **体验细节**
   - 绑定 `DragAndDropController` 实现拖拽目录。
   - 将日志输出方法抽成工具，支持级别颜色和自动滚动。
   - 为耗时操作增加进度指示（如 `ProgressIndicator` 或状态标签），防止卡死误判。

## 待确认事项
- 分支网格中是否需要展示文件预览/属性，抑或仅提供数量与操作按钮即可。
- 批量处理是否需要提供细粒度勾选（挑选部分文件）或按类型一键全选。
- 生成/解析输出目标的命名规则是否沿用现有逻辑，还是允许自定义（例如统一输出到新的目录）。

确认上述事项后即可进入 FXML 与控制器的具体改造。

